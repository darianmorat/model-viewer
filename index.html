<!DOCTYPE html>
<html>

<head>
   <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>

   <style>
      html,
      body {
         height: 100vh;
         margin: 0;
         padding: 0;
         /* overflow: hidden; */
      }

      model-viewer {
         width: 100%;
         height: 100%;
      }

      /* This keeps child nodes hidden while the element loads */
      :not(:defined)>* {
         display: none;
      }

      model-viewer {
         background-color: #eee;
         overflow-x: hidden;
      }

      #ar-button {
         background-image: url(./assets/ic_view_in_ar_new_googblue_48dp.png);
         background-repeat: no-repeat;
         background-size: 20px 20px;
         background-position: 12px 50%;
         background-color: #fff;
         position: absolute;
         left: 50%;
         transform: translateX(-50%);
         white-space: nowrap;
         top: 132px;
         padding: 0px 16px 0px 40px;
         font-family: Roboto Regular, Helvetica Neue, sans-serif;
         font-size: 18px;
         color: #4285f4;
         height: 56px;
         line-height: 36px;
         border-radius: 18px;
         border: 1px solid #DADCE0;
      }

      #ar-button:active {
         background-color: #E8EAED;
      }

      #ar-button:focus {
         outline: none;
      }

      #ar-button:focus-visible {
         outline: 1px solid #4285f4;
      }

      @keyframes circle {
         from {
            transform: translateX(-50%) rotate(0deg) translateX(50px) rotate(0deg);
         }

         to {
            transform: translateX(-50%) rotate(360deg) translateX(50px) rotate(-360deg);
         }
      }

      @keyframes elongate {
         from {
            transform: translateX(100px);
         }

         to {
            transform: translateX(-100px);
         }
      }

      model-viewer>#ar-prompt {
         position: absolute;
         left: 50%;
         bottom: 175px;
         animation: elongate 2s infinite ease-in-out alternate;
         display: none;
      }

      model-viewer[ar-status="session-started"]>#ar-prompt {
         display: block;
      }

      model-viewer>#ar-prompt>img {
         animation: circle 4s linear infinite;
      }

      model-viewer>#ar-failure {
         position: absolute;
         left: 50%;
         transform: translateX(-50%);
         bottom: 175px;
         display: none;
      }

      model-viewer[ar-tracking="not-tracking"]>#ar-failure {
         display: block;
      }

      .slider {
         width: 100%;
         text-align: center;
         overflow: hidden;
         position: absolute;
         bottom: 16px;
      }

      .slides {
         display: flex;
         overflow-x: auto;
         scroll-snap-type: x mandatory;
         scroll-behavior: smooth;
         -webkit-overflow-scrolling: touch;
      }

      .slide {
         scroll-snap-align: start;
         flex-shrink: 0;
         width: 100px;
         height: 100px;
         background-size: contain;
         background-repeat: no-repeat;
         background-position: center;
         background-color: #fff;
         margin: 10px 10px 0 10px;
         border-radius: 10px;
         border: none;
         display: flex;
      }

      .slide.selected {
         border: 2px solid #4285f450;
         background-color: #20202050;
      }

      .slide:focus {
         outline: none;
      }

      .slide:focus-visible {
         outline: 1px solid #4285f4;
      }

      @media (max-height: 700px) {
         #ar-button {
            top: 80px;
         }
      }


      /* TESTING HERE */
      /* TESTING HERE */
      /* TESTING HERE */
      /* TESTING HERE */
      /* TESTING HERE */
      /* TESTING HERE */
      #controls {
         position: absolute;
         bottom: 16px;
         left: 16px;
         max-width: unset;
         transform: unset;
         pointer-events: auto;
         z-index: 100;
      }

      .dot {
         display: none;
      }

      .glass {
         background: rgba(255, 255, 255, 0.27);
         backdrop-filter: blur(8px) contrast(0.89) saturate(1.27);
         -webkit-backdrop-filter: blur(8px) contrast(0.89) saturate(1.27);
         border: 1px solid rgba(255, 255, 255, 0.4);
         padding: 0.5rem;
         border-radius: 0.5rem;
      }

      .dim {
         background: rgba(255, 255, 255, 0.57);
         border-radius: 4px;
         border: none;
         box-sizing: border-box;
         box-shadow: 0 2px 4px rgba(0, 0, 0, 0.35);
         color: rgba(0, 0, 0, 0.8);
         display: block;
         font-family: Futura, Helvetica Neue, sans-serif;
         font-weight: 700;
         max-width: 128px;
         overflow-wrap: break-word;
         padding: 0.5em 1em;
         position: absolute;
         width: max-content;
         height: max-content;
         transform: translate3d(-50%, -50%, 0);
         pointer-events: none;
         --min-hotspot-opacity: 0;
         margin: 10px;
      }

      .dimensionLineContainer {
         pointer-events: none;
         display: block;
      }

      .dimensionLine {
         stroke: #40c3ff;
         stroke-width: 2;
         stroke-dasharray: 2;
      }

      .hide {
         display: none;
      }

      /* Mobile-specific styles */
      @media (max-width: 600px) {
         model-viewer {
            height: 70vh;
            /* Adjust height for mobile */
         }

         #controls {
            bottom: 8px;
            left: 8px;
            padding: 0.3rem;
            font-size: 0.7em;
         }

         .dim {
            font-size: 3vw;
            padding: 0.3em 0.6em;
         }

         #ar-button {
            font-size: 14px;
            height: 48px;
            padding: 0px 12px 0px 36px;
            background-size: 16px 16px;
            background-position: 10px 50%;
         }

         /* Make controls more touch-friendly */
         select,
         input[type="checkbox"] {
            transform: scale(1.3);
            transform-origin: left;
            margin: 5px 0;
         }

         label {
            display: inline-block;
            margin-top: 5px;
         }
      }
   </style>

</head>

<body>
   <model-viewer src="./assets/ShopifyModels/baldosa1.glb" poster="./assets/ShopifyModels/Chair.webp"
      max-camera-orbit="auto 80deg 40m" skybox-image='./assets/environments/small_hangar_01_1k.jpg' skybox-height="6m"
      xr-environment alt="A 3D model" id="dimension-demo" ar ar-modes="webxr" ar-scale="fixed"
      camera-orbit="-30deg 65deg 20m" shadow-intensity="1" camera-controls touch-action="pan-y">

      <button slot="ar-button" id="ar-button">
         View in your space
      </button>

      <div id="ar-prompt">
         <img src="./assets/hand.png">
      </div>

      <button id="ar-failure">
         AR is not tracking!
      </button>



      <!-- TESTING HERE -->
      <!-- TESTING HERE -->
      <!-- TESTING HERE -->
      <!-- TESTING HERE -->
      <!-- TESTING HERE -->

      <button slot="hotspot-dot+X+Z" class="dot" data-position="1 0 1" data-normal="0 1 0"></button>
      <button slot="hotspot-dot-X+Z" class="dot" data-position="-1 0 1" data-normal="0 1 0"></button>
      <button slot="hotspot-dot+X-Z" class="dot" data-position="1 0 -1" data-normal="0 1 0"></button>
      <button slot="hotspot-dot-X-Z" class="dot" data-position="-1 0 -1" data-normal="0 1 0"></button>

      <button slot="hotspot-dim+X-top" class="dim" data-position="0 0 1.2" data-normal="0 0 1"></button>
      <button slot="hotspot-dim+X-bottom" class="dim" data-position="0 0 -1.2" data-normal="0 0 -1"></button>
      <button slot="hotspot-dim+Z-right" class="dim" data-position="1.2 0 0" data-normal="1 0 0"></button>
      <button slot="hotspot-dim+Z-left" class="dim" data-position="-1.2 0 0" data-normal="-1 0 0"></button>

      <svg id="dimLines" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" class="dimensionLineContainer">
         <line class="dimensionLine"></line>
         <line class="dimensionLine"></line>
         <line class="dimensionLine"></line>
         <line class="dimensionLine"></line>
      </svg>

      <div id="controls" class="dim glass">
         <label for="src">Product:</label>
         <select id="src">
            <option value="./assets/ShopifyModels/baldosa1.glb">baldosa1</option>
            <option value="./assets/ShopifyModels/Chair.glb">chair</option>
         </select><br>

         <label for="show-dimensions">Show Dimensions:</label>
         <input id="show-dimensions" type="checkbox" checked="true">
      </div>
   </model-viewer>


   <script type="module">
      // const modelViewer = document.querySelector("model-viewer");
      //
      // window.switchSrc = (element, name) => {
      //    const base = "./assets/ShopifyModels/" + name;
      //    modelViewer.src = base + '.glb';
      //    modelViewer.poster = base + '.webp';
      //    const slides = document.querySelectorAll(".slide");
      //    slides.forEach((element) => {element.classList.remove("selected");});
      //    element.classList.add("selected");
      // };
      //
      // document.querySelector(".slider").addEventListener('beforexrselect', (ev) => {
      //    ev.preventDefault();
      // });

      // TESTING HERE
      // TESTING HERE
      // TESTING HERE
      // TESTING HERE
      // TESTING HERE
      const modelViewer = document.querySelector('#dimension-demo');

      modelViewer.querySelector('#src').addEventListener('input', (event) => {
         modelViewer.src = event.target.value;
      });

      const checkbox = modelViewer.querySelector('#show-dimensions');
      const dimElements = [...modelViewer.querySelectorAll('button'), modelViewer.querySelector('#dimLines')];

      function setVisibility(visible) {
         dimElements.forEach((element) => {
            if (visible) {
               element.classList.remove('hide');
            } else {
               element.classList.add('hide');
            }
         });
      }

      checkbox.addEventListener('change', () => {
         setVisibility(checkbox.checked);
      });

      modelViewer.addEventListener('ar-status', (event) => {
         setVisibility(checkbox.checked && event.detail.status !== 'session-started');
      });

      // update svg
      function drawLine(svgLine, dotHotspot1, dotHotspot2, dimensionHotspot) {
         if (dotHotspot1 && dotHotspot2) {
            svgLine.setAttribute('x1', dotHotspot1.canvasPosition.x);
            svgLine.setAttribute('y1', dotHotspot1.canvasPosition.y);
            svgLine.setAttribute('x2', dotHotspot2.canvasPosition.x);
            svgLine.setAttribute('y2', dotHotspot2.canvasPosition.y);

            // use provided optional hotspot to tie visibility of this svg line to
            if (dimensionHotspot && !dimensionHotspot.facingCamera) {
               svgLine.classList.add('hide');
            } else {
               svgLine.classList.remove('hide');
            }
         }
      }

      const dimLines = modelViewer.querySelectorAll('line');

      const renderSVG = () => {
         // Draw X dimension lines (width) - top and bottom
         drawLine(dimLines[0], modelViewer.queryHotspot('hotspot-dot-X+Z'), modelViewer.queryHotspot('hotspot-dot+X+Z'), modelViewer.queryHotspot('hotspot-dim+X-top'));
         drawLine(dimLines[1], modelViewer.queryHotspot('hotspot-dot-X-Z'), modelViewer.queryHotspot('hotspot-dot+X-Z'), modelViewer.queryHotspot('hotspot-dim+X-bottom'));

         // Draw Z dimension lines (length) - left and right  
         drawLine(dimLines[2], modelViewer.queryHotspot('hotspot-dot+X-Z'), modelViewer.queryHotspot('hotspot-dot+X+Z'), modelViewer.queryHotspot('hotspot-dim+Z-right'));
         drawLine(dimLines[3], modelViewer.queryHotspot('hotspot-dot-X-Z'), modelViewer.queryHotspot('hotspot-dot-X+Z'), modelViewer.queryHotspot('hotspot-dim+Z-left'));
      };

      modelViewer.addEventListener('load', () => {
         const center = modelViewer.getBoundingBoxCenter();
         const size = modelViewer.getDimensions();
         const x2 = size.x / 2;
         const z2 = size.z / 2;

         // Create hotspots for the 4 corners of the tile (on the flat surface)
         modelViewer.updateHotspot({
            name: 'hotspot-dot+X+Z',
            position: `${center.x + x2} ${center.y} ${center.z + z2}`
         });

         modelViewer.updateHotspot({
            name: 'hotspot-dot-X+Z',
            position: `${center.x - x2} ${center.y} ${center.z + z2}`
         });

         modelViewer.updateHotspot({
            name: 'hotspot-dot+X-Z',
            position: `${center.x + x2} ${center.y} ${center.z - z2}`
         });

         modelViewer.updateHotspot({
            name: 'hotspot-dot-X-Z',
            position: `${center.x - x2} ${center.y} ${center.z - z2}`
         });

         // Width labels (X dimension) - top and bottom
         modelViewer.updateHotspot({
            name: 'hotspot-dim+X-top',
            position: `${center.x} ${center.y} ${center.z + z2 * 1.12}`
         });
         modelViewer.querySelector('button[slot="hotspot-dim+X-top"]').textContent =
            `${(size.x * 100).toFixed(0)} cm`;

         modelViewer.updateHotspot({
            name: 'hotspot-dim+X-bottom',
            position: `${center.x} ${center.y} ${center.z - z2 * 1.12}`
         });
         modelViewer.querySelector('button[slot="hotspot-dim+X-bottom"]').textContent =
            `${(size.x * 100).toFixed(0)} cm`;

         // Length labels (Z dimension) - left and right
         modelViewer.updateHotspot({
            name: 'hotspot-dim+Z-right',
            position: `${center.x + x2 * 1.2} ${center.y} ${center.z}`
         });
         modelViewer.querySelector('button[slot="hotspot-dim+Z-right"]').textContent =
            `${(size.z * 100).toFixed(0)} cm`;

         modelViewer.updateHotspot({
            name: 'hotspot-dim+Z-left',
            position: `${center.x - x2 * 1.2} ${center.y} ${center.z}`
         });
         modelViewer.querySelector('button[slot="hotspot-dim+Z-left"]').textContent =
            `${(size.z * 100).toFixed(0)} cm`;

         renderSVG();

         modelViewer.addEventListener('camera-change', renderSVG);
      });
   </script>
</body>


</html>
